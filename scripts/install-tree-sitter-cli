#! /usr/bin/env bash
#
# Install the tree-sitter CLI needed to generate parsers.
#
set -eu -o pipefail

dir_name=$(dirname "$BASH_SOURCE")
if ! [[ -d downloads/tree-sitter ]]; then
  "$dir_name"/download-tree-sitter
fi

(
  cd downloads/tree-sitter
  cargo build
)

real_exe=downloads/tree-sitter/target/debug/tree-sitter

if ! [[ -x "$real_exe" ]]; then
  cat >&2 <<EOF
Compilation of tree-sitter failed or the binary is not where we were
expecting it. The expected path is:
$real_exe
EOF
  exit 1
fi

exe=bin/tree-sitter
mkdir -p bin
ln -sf ../"$real_exe" "$exe"

cat <<EOF
The tree-sitter binary is:
$(pwd)/$exe
EOF
